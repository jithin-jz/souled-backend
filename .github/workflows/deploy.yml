name: Deploy to EC2

on:
  push:
    branches:
      - main # Change to your main branch name if different
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          # Setup SSH
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

          # Create .ssh directory if it doesn't exist
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Add EC2 to known hosts
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts

          # Deploy to EC2
          ssh -i private_key.pem -o StrictHostKeyChecking=no $USER@$HOST << 'ENDSSH'
            # Navigate to project directory
            cd /home/ubuntu/backend/souled-backend
            
            # Check if this is a git repository
            if [ -d .git ]; then
              echo "Git repository found, pulling latest changes..."
              git pull origin main
            else
              echo "Not a git repository. Please initialize Git on EC2 first."
              echo "Run: git init && git remote add origin YOUR_REPO_URL && git pull origin main"
              exit 1
            fi
            
            # Activate virtual environment
            source venv/bin/activate
            
            # Install/update dependencies
            pip install -r requirements.txt
            
            # Run migrations
            python manage.py migrate --noinput
            
            # Collect static files
            python manage.py collectstatic --noinput
            
            # Restart Gunicorn
            sudo systemctl restart gunicorn
            
            # Check Gunicorn status
            sudo systemctl status gunicorn --no-pager
            
            echo "Deployment completed successfully!"
          ENDSSH

          # Cleanup
          rm -f private_key.pem
